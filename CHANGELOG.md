# Changelog

## Unreleased
- **Added:** Auth proxy for session refresh (T101)
  - Proxy at `src/proxy.ts` refreshes Supabase auth cookies on each request
  - Ensures session cookies are refreshed before expiration
  - Configured to run on all routes except static files
  - Uses Next.js 16 proxy convention (replaces deprecated middleware)
- **Added:** User accounts infrastructure with profiles table (T100)
  - Profiles table created with id, email, display_name, created_at, updated_at
  - Auto-creates profile when user signs up via Supabase Auth
  - Row Level Security ensures users can only access their own profile
- **Performance:** Batched admin upload queries for improved performance (T092)
  - CSV upload now uses batch queries instead of N+1 queries per row
  - Target: 2-3 total queries for indicators + releases regardless of row count
  - Indicators are batch-fetched, then batch-inserted/updated
  - Releases are batch-fetched (chunked at 50), then batch-inserted/updated
- **Tests:** Added unit tests for CSV parser (T091)
  - Extracted CSV parser into reusable module at `src/lib/csv-parser.ts`
  - Added 30 unit tests covering: quoted fields, escaped quotes, empty fields, malformed rows
  - Set up Vitest testing framework with `npm test` script
- **Docs:** Updated to L1 scope (auth + watchlists)
  - SPEC, ROADMAP, README, DEPLOY, RISKS, and templates aligned to L1
  - L0 task/audit docs marked as archive; app README replaced with project-specific guide
  - Backlog populated with L2 ideas surfaced during documentation pass
- **Security:** RLS policies now included in migration file (T090)
  - Row Level Security automatically enabled on fresh deployments
  - Public read-only access enforced; anon key cannot INSERT/UPDATE/DELETE
  - DEPLOY.md updated to document verification steps instead of manual SQL
- **Added:** SEO metadata and dynamic page titles (T051)
  - Root layout includes Open Graph and Twitter card meta tags
  - Indicator detail pages have dynamic titles showing indicator name and country (e.g., "CPI (YoY) (US)")
  - Admin pages marked as noindex/nofollow for search engines
  - Uses Next.js title template for consistent page title suffix
- **Added:** Empty states and loading states for better UX (T050)
  - Calendar page shows friendly "No upcoming releases" message when no results match filters
  - Added skeleton loading animations for Calendar page while data loads
  - Added skeleton loading animations for Indicator detail page while data loads
- **Security:** Admin upload endpoint now requires ADMIN_UPLOAD_SECRET (T042)
  - Requests without secret or with invalid secret receive 401 Unauthorized
  - Secret must be set in environment variables
- **Added:** CSV upload POST endpoint at `/api/admin/upload` (T041)
  - Accepts multipart form data with CSV file
  - Validates CSV structure using Zod (required: indicator_name, country_code, category, source_name, source_url, release_at, period)
  - Optional columns: actual, forecast, previous, revised, unit, notes
  - Upserts indicators (matched by name + country_code) and inserts/updates releases (matched by indicator_id + release_at + period)
  - Returns detailed validation errors with row numbers for invalid CSV
  - Admin upload form now submits to the API and shows success/error feedback
- **Added:** Admin upload page at `/admin/upload` with CSV file upload form (T040)
  - Includes file input, admin secret field, and CSV format documentation
  - Upload submission placeholder pending T041 route handler implementation
- **Added:** Historical releases table on indicator detail page (T031)
  - Fetches up to 200 releases ordered by date descending (most recent first)
  - Displays Date, Period, Actual, Forecast, Previous, Revised columns
  - Actual values highlighted in green; units displayed when available
  - Shows empty state message when no releases exist
  - Error state displayed if database query fails
- **Added:** Indicator detail page scaffold at `/indicator/[id]` (T030)
  - Displays indicator header with name, country, category, and source link
  - Indicator names in calendar are now clickable links to detail page
  - Shows placeholder for historical releases (to be implemented in T031)
- Initial scaffolding
- Created Supabase database schema (indicators and releases tables with indexes)
- Added environment variable validation with zod (src/lib/env.ts)
- Added Supabase client wrappers for server and client components
- **Fixed:** Environment validation now runs at startup via next.config.ts import (fail-fast on missing env vars)
- Added calendar page "/" with table layout showing placeholder release data (T020)
- Calendar page now queries real releases from Supabase (next 7 days, joined with indicators, ordered by release_at) (T021)
- Calendar table now shows separate columns: Actual, Forecast, Previous, Revised (T024)
  - Actual values display in green bold when released
  - Revised column visible for all rows (shows "â€”" when no data)
- **Verified:** `revised` column correctly included in Supabase query; added test seed data with revised value (T025)
- Added filter dropdowns for Country and Category on calendar page (T022)
  - Filters use URL search params for bookmarkable/shareable state
  - Clear filters button appears when any filter is active
- Added search input for indicator name on calendar page (T023)
  - Search is case-insensitive and matches partial indicator names
  - Search uses URL search params and debounces input (300ms)
  - Can be combined with country and category filters
- Updated app metadata: browser title now shows "Macro Calendar" instead of placeholder (T060)
- Expanded root README with project overview, structure, quick start guide, and features list (T060)
- **Improved:** Added graceful error handling for database failures (T061)
  - Supabase query errors now return error states instead of silent empty arrays
  - User sees clear error message "Unable to load calendar data" when DB connection fails
  - Error message displayed in red alert banner instead of blank table
- **Added:** CI/CD pipeline via GitHub Actions (T062)
  - Runs lint, build, and security audit on every PR and push to main
  - Uses npm audit with high severity threshold
  - Build job validates TypeScript compilation with placeholder env vars- **Improved:** Added Zod validation for all Supabase responses (T063)
  - Validates structure of releases and filter options data at runtime
  - Catches malformed database responses with clear error messages
  - Replaced unsafe type casts with schema-based validation
- **Improved:** Added inline code comments for security and clarity (T065)
  - Documented that `ilike()` search is SQL injection safe via parameterized queries
  - Explained timezone handling assumptions in `formatReleaseTime()` function
- **Added:** Comprehensive deployment guide (DEPLOY.md) with Vercel and Supabase setup instructions (T064)
  - Step-by-step deployment checklist for new developers
  - Environment variable configuration guide
  - Security best practices including secret rotation
  - Monitoring tips and troubleshooting section